# Task Management System - Bắc Ninh Administrative Service Center

## Overview
This system is a comprehensive task management solution for the Bắc Ninh Provincial Administrative Service Center, designed to streamline government administrative workflows. It facilitates task assignment, progress tracking, KPI calculation, and offers AI-powered insights. The application supports a hierarchical organizational structure with robust role-based access control and performance monitoring, tailored for Vietnamese administrative processes. The project aims to enhance efficiency and transparency in public service, improving public service delivery and providing valuable data for policy-making.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### UI/UX Decisions
The frontend uses React 18 with TypeScript, Vite, Wouter for routing, and TanStack Query for state management. It leverages Shadcn UI (built on Radix UI) for accessible, Material Design-inspired components. A custom Tailwind CSS configuration extends a professional color palette (primary blue #1976D2) and includes status-specific colors. The Inter font supports Vietnamese diacritics, and responsive grid layouts ensure optimal viewing across devices, with specific mobile optimizations for breakpoints and touch-friendly elements. A centralized badge variant system provides consistent visual theming for task statuses, priorities, and assignment roles. Task cards are color-coded to distinguish parent tasks (light blue) and subtasks (light yellow), with visual indicators and localized badges. User interfaces prioritize displaying "chức vụ" (position) over "vai trò" (role) for better readability, and user lists are sorted hierarchically by role. A "Không thời hạn" (No Deadline) feature allows tasks to be created without an immediate deadline, setting it to December 31 of the next year. All static text is localized to Vietnamese.

### Technical Implementations
The backend is an Express.js server in TypeScript, utilizing session-based authentication with `express-session` and a PostgreSQL store. It follows a RESTful API design with role-based access control. Password hashing is done with Bcrypt (10 salt rounds). A hierarchical role system includes Director, Deputy Director, Department Head, Deputy Department Head, and Staff, with defined permissions. A sophisticated KPI calculation system is implemented, combining completion and quality scores with role coefficients and priority weighting, with updated early completion bonus thresholds. The system includes a robust task numbering system (`#YY-XXX` format) with yearly resets and transaction-based sequence generation.

Key features include:
- **Authentication & Authorization:** Session-based login, role-based access.
- **Task Management:** CRUD, assignment, progress tracking, commenting, file attachments, and smart role assignment logic. Supports parent/child tasks (subtasks) with **automatic parent status updates**: parent tasks automatically change to "Hoàn thành" when all subtasks are completed, regardless of the parent's own checklist items. Parent status is determined by subtask completion, with intelligent deletion handling.
- **Dashboards & Reporting:** Role-based views, dynamic filtering, KPI display, real-time statistics, comprehensive task reports with time-based analysis, visual analytics, and professional export functionality (Excel/PDF).
- **Evaluation System:** Per-assignment evaluation with scores and comments, influencing KPI.
- **Admin Management:** Comprehensive department and user management with dependency validation, including an optional `position` field distinct from system `role`. Includes hidden system admin account (username: `sysadmin`) with Director-level permissions that doesn't appear in user lists.
- **Telegram Notifications:** Real-time notifications for task events and scheduled reports (AI Suggestions, AI Alerts, Weekly/Monthly KPI) with individual user opt-in and department group notifications, featuring milestone-based deadline notifications.
- **Department KPI Comparison:** Visual comparison of department performance for leadership roles.
- **AI Risk Prediction:** Focused deadline risk detection system that creates one alert per at-risk task. Only tracks deadline risks (tasks at risk of missing deadline based on remaining time and progress percentage), which directly impact KPI scores. Eliminated non-critical alerts (complexity, resource, quality, coordination) to reduce alert fatigue.

### System Design Choices
- **Database:** PostgreSQL with Drizzle ORM, using a normalized relational schema with UUID primary keys and timestamp tracking. Includes specific fields for soft deletion and user preferences for Telegram notifications.
- **Security:** Bcrypt for password hashing, HTTP-only and secure session cookies, session-based authentication, role-based access control, explicit `queryFn` for all React Query queries, and data integrity checks. **Session Management:** Development uses in-memory session store for speed; Production uses PostgreSQL session store via `connect-pg-simple` to persist sessions across app restarts and prevent unexpected logouts.
- **Development Tools:** TypeScript path aliases, PostCSS with Tailwind and Autoprefixer. React Query's `staleTime` is set to `0` and `refetchOnMount` to `"always"` to ensure data consistency.
- **Test Data:** Development environment includes 12 test tasks (#25-005 to #25-016) across 4 departments for testing purposes. Created via `scripts/create-test-tasks.ts` using direct database queries (bypassing storage layer for efficiency).
- **Production Deployment:** Use `scripts/import-to-production.ts` with `DATABASE_URL_PROD` environment variable to programmatically import complete database snapshot (37 users, 23 tasks, 4 departments, 43 assignments, 36 checklist items, 7 AI alerts). Default passwords: regular users "123456", system admin "Admin@2025". Development and production databases are separate. Session store automatically creates `user_sessions` table in production database.

### Recent Updates & Bug Fixes
- **Auto-Logout Idle Timeout (Nov 17, 2025):** Implemented automatic logout after 5 minutes of user inactivity to enhance security. System tracks mouse, keyboard, scroll, touch, and click events. Shows warning dialog after 4.5 minutes with 30-second countdown. User can choose to "Continue working" or "Logout now". Component uses refs to avoid closure issues and properly manages event listeners. Files: `client/src/components/IdleTimeout.tsx`, integrated in `client/src/App.tsx`.
- **Department Head Assignment Editing (Nov 16, 2025):** Enhanced assignment edit permissions to allow Trưởng phòng/Phó Trưởng phòng to modify task assignments if the task was created by Phó Giám đốc. This enables proper delegation workflow where Deputy Directors assign to Department Heads, who can then reassign to staff. Includes assignment change logging in `progress_updates` table (type: `assignment_changed`) and visual timeline display in TaskDetail with blue-highlighted entries showing who changed assignments and what changed.
- **AI Duplicate Task Detection (Nov 16, 2025):** Implemented AI-powered duplicate detection using Groq API to warn users when creating tasks similar to existing ones. System analyzes title/description against recent incomplete tasks (last 30 days) in user's department, showing similarity scores ≥60%. Warning dialog displays before task creation with options to "View similar task" or "Create anyway". Respects role-based access: Leadership sees duplicates across all departments, regular users only in their department. Endpoint: `POST /api/tasks/check-duplicates`.
- **AI Alerts Scope Narrowing (Nov 15, 2025):** Dramatically reduced alert volume by 89% (from 65 to 7 alerts) by focusing only on KPI-critical deadline risks. Modified `detectTaskRisks()` to eliminate non-essential alert types (no_updates, complexity, resource, quality, coordination). Each task now generates maximum ONE alert based on 4-tier deadline risk assessment: (0) Overdue tasks, (1) ≤2 days with <50% progress, (2) ≤5 days with <70% progress, (3) ≤7 days with <50% progress. All alerts are `deadline_risk` type with high or medium severity. This change addresses alert fatigue while maintaining focus on metrics directly impacting KPI scores.
- **AI Alerts Role-Based Filtering (Nov 15, 2025):** Fixed duplicate alert issue and implemented proper role-based viewing. Changed alert creation logic to only notify người chủ trì (assignmentRole = "Chủ trì") and department leadership (Trưởng phòng/Phó Trưởng phòng), eliminating duplicates. Implemented hierarchical viewing: (1) Giám đốc/Phó Giám đốc see ALL alerts across all departments, (2) Trưởng phòng/Phó Trưởng phòng see only alerts for tasks in their department (filtered by task.departmentId), (3) Staff see only their own alerts. Database-persisted alerts use `ai_alerts` table with severity mapping based on risk type.
- **System Admin Account (Nov 15, 2025):** Created hidden system admin account with username `sysadmin` for emergency system administration. Added `isSystemAdmin` boolean field to users table. Updated `getUsers()` storage function to filter out system admin accounts from all user lists. System admin has Director-level permissions but is not affiliated with any department and doesn't appear in user management, task assignment, or KPI reports. Script available at `scripts/create-system-admin.ts`.
- **Parent Task Auto-Status Update (Nov 15, 2025):** Implemented automatic parent task status calculation based on subtask completion. Created `recalculateTaskStatusFromSubtasks` function that determines parent status from all subtasks. Updated checklist endpoints (CREATE/UPDATE/DELETE) to call this function after updating task status, ensuring parent tasks with both checklist items AND subtasks prioritize subtask completion for status determination. This prevents conflicts where parent checklist completion overrides subtask-based status.
- **DepartmentTasks.tsx Race Condition (Nov 15, 2025):** Fixed initialization issue where `selectedDepartment` state started as empty string, causing department filter dropdown to show placeholder instead of actual value and preventing tasks from loading. Solution: Simplified useEffect dependency to `[user?.id, canViewAllDepartments]` to ensure department selection is properly initialized when user loads.

## External Dependencies

- **Groq API:** Integrated for task quality evaluation, risk detection, reassignment suggestions, daily task summaries, and task report insights using the `llama-3.3-70b-versatile` model (migrated from OpenAI on November 15, 2025).
- **Multer:** For handling multipart form data for file uploads.
- **connect-pg-simple:** PostgreSQL-backed session storage for `express-session`.
- **@neondatabase/serverless:** For serverless PostgreSQL connectivity.
- **Recharts:** For data visualization.
- **xlsx:** JavaScript library for Excel file generation.